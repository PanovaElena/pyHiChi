cmake_minimum_required(VERSION 3.1)

set(CMAKE_CXX_STANDARD 11)

option(USE_OMP ON)

project(fftw)

if (USE_OMP)
	find_package(OpenMP)
	if (OPENMP_FOUND)
		set (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${OpenMP_C_FLAGS}")
		set (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${OpenMP_CXX_FLAGS}")
		set (CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} ${OpenMP_EXE_LINKER_FLAGS}")
	endif()
endif()

set(FFTW_VERSION 3.3.8)
set(FFTW_DIR "${CMAKE_SOURCE_DIR}")
set(FFTW_INSTALL_DIR "${FFTW_DIR}/fftw-install")
set(FFTW_BUILD_DIR "${CMAKE_CURRENT_BINARY_DIR}")

include(ExternalProject)
ExternalProject_Add(fftw
		URL "http://fftw.org/fftw-${FFTW_VERSION}.tar.gz"
		PREFIX ${FFTW_BUILD_DIR}
		DOWNLOAD_DIR ${FFTW_BUILD_DIR}
		SOURCE_DIR ${FFTW_DIR}/fftw
		INSTALL_DIR ${FFTW_INSTALL_DIR}
		TMP_DIR ${FFTW_BUILD_DIR}/tmp
		STAMP_DIR ${FFTW_BUILD_DIR}/stamp
		BINARY_DIR ${FFTW_BUILD_DIR}/build
		CMAKE_ARGS
			"-DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}"
			"-DCMAKE_CXX_COMPILER=${CMAKE_CXX_COMPILER}"
			"-DCMAKE_C_FLAGS=${CMAKE_C_FLAGS}"
			"-DCMAKE_CXX_FLAGS=${CMAKE_CXX_FLAGS}"
			"-DCMAKE_EXE_LINKER_FLAGS=${CMAKE_EXE_LINKER_FLAGS}"
			"-DBUILD_SHARED_LIBS=OFF"
			"-DCMAKE_POSITION_INDEPENDENT_CODE=ON"
			"-DENABLE_AVX2=ON"
			"-DCMAKE_INSTALL_PREFIX=${FFTW_INSTALL_DIR}" 
			"-DENABLE_OPENMP=${USE_OMP}"
			"-DBUILD_TESTS=OFF"
)
install(DIRECTORY "${FFTW_DIR}" DESTINATION .)

message(STATUS "FFTW install directory is '${FFTW_INSTALL_DIR}'")
